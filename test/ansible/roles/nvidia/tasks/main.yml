---
# NVIDIA Container Toolkit installation
# Ensures GPU access for Docker containers

- name: Check if NVIDIA driver is installed
  ansible.builtin.command: nvidia-smi
  register: nvidia_smi_check
  changed_when: false
  failed_when: false

- name: Fail if NVIDIA driver is not available
  ansible.builtin.fail:
    msg: "NVIDIA driver not found. This node requires pre-installed NVIDIA drivers."
  when: nvidia_smi_check.rc != 0

- name: Get NVIDIA driver version
  ansible.builtin.shell: nvidia-smi --query-gpu=driver_version --format=csv,noheader | head -1
  register: nvidia_driver_version
  changed_when: false

- name: Display NVIDIA driver info
  ansible.builtin.debug:
    msg: "NVIDIA driver version: {{ nvidia_driver_version.stdout }}"

- name: Check if nvidia-container-toolkit is installed
  ansible.builtin.command: which nvidia-container-toolkit
  register: nct_check
  changed_when: false
  failed_when: false

- name: Add NVIDIA container toolkit GPG key
  ansible.builtin.apt_key:
    url: https://nvidia.github.io/libnvidia-container/gpgkey
    state: present
  when: nct_check.rc != 0 and ansible_os_family == "Debian"

- name: Add NVIDIA container toolkit repository (Debian/Ubuntu)
  ansible.builtin.apt_repository:
    repo: "deb https://nvidia.github.io/libnvidia-container/stable/deb/$(ARCH) /"
    state: present
    filename: nvidia-container-toolkit
  when: nct_check.rc != 0 and ansible_os_family == "Debian"

- name: Install NVIDIA container toolkit (Debian/Ubuntu)
  ansible.builtin.apt:
    name: nvidia-container-toolkit
    state: present
    update_cache: yes
  when: nct_check.rc != 0 and ansible_os_family == "Debian"
  notify: restart docker

- name: Configure Docker to use NVIDIA runtime
  ansible.builtin.command: nvidia-ctk runtime configure --runtime=docker
  when: nct_check.rc != 0
  notify: restart docker

- name: Verify GPU access in Docker
  ansible.builtin.command: docker run --rm --gpus all nvidia/cuda:12.0-base nvidia-smi
  register: docker_gpu_check
  changed_when: false
  retries: 3
  delay: 10
  until: docker_gpu_check.rc == 0
  when: docker_service_running is defined and docker_service_running

- name: Get GPU information
  ansible.builtin.shell: |
    nvidia-smi --query-gpu=name,memory.total,compute_cap --format=csv,noheader
  register: gpu_info
  changed_when: false

- name: Display GPU information
  ansible.builtin.debug:
    msg: "GPU: {{ gpu_info.stdout }}"
